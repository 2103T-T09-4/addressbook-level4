<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Car park Finder maps</title>
    <style>
        /* Always set the map height explicitly to define the size of the div
         * element that contains the map. */
        #map {
            height: 100%;
        }
        /* Optional: Makes the sample page fill the window. */
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
    </style>
</head>

<body>
<div id="map"></div>
<script>
        function getJsonFromUrl() {
            var query = location.search.substr(1);
            var result = {};
            query.split("&").forEach(function(part) {
                var item = part.split("=");
                result[item[0]] = decodeURIComponent(item[1]);
            });
            return result;
        }
        var map;
        var prev_infowindow = false;
        var markersArray = [];

        function clearOverlays() {
            for (var i = 0; i < markersArray.length; i++) {
                markersArray[i].close();
            }
            markersArray.length = 0;
        }

        google.maps.InfoWindow.prototype.isOpen = false;
        function initMap() {
            var theUrl = "https://data.gov.sg/api/action/datastore_search?resource_id=139a3035-e624-4f56-b63f-89ae28d4ae4c&limit=2000&offset=";
            var offset = 0;
            var cv = new SVY21();
            var carparkRecords = [];

            do {
                var xmlHttp = new XMLHttpRequest();
                xmlHttp.open( "GET", theUrl + offset, false ); // false for synchronous request
                xmlHttp.send( null );
                //console.log(xmlHttp.responseText);
                var jsonObject = JSON.parse(xmlHttp.responseText);
                for (var i = 0; i < jsonObject.result.records.length; i++) {
                    carparkRecords.push(jsonObject.result.records[i]);
                }
                offset += 2000;
            } while (jsonObject.result.records.length == 2000)

            let filteredCarparkRecords = carparkRecords.filter(function({address, car_park_no, car_park_type,
            free_parking, night_parking, short_term_parking, type_of_parking_system,
            x_coord, y_coord}) {
                return !this.has(address) && !this.has(car_park_no) &&
                !this.has(car_park_type) && !this.has(free_parking) &&
                !this.has(night_parking) && !this.has(short_term_parking) &&
                !this.has(type_of_parking_system) && !this.has(x_coord) &&
                !this.has(y_coord) && this.add(car_park_no);
            }, new Set);
            let iterator = filteredCarparkRecords.values();

            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 11,
                center: {lat: 1.3521, lng: 103.8198},
                mapTypeId: google.maps.MapTypeId.TERRAIN
            });

            for (var i = 0; i < filteredCarparkRecords.length; i++) {
                var coords = iterator.next().value;
                var result = cv.computeLatLon(coords.y_coord, coords.x_coord);
                var latLng = new google.maps.LatLng(result.lat,result.lon);
                var marker = new google.maps.Marker({
                    map: map,
                    title: coords.car_park_no,
                    position: latLng
                });
                markersArray.push(marker);
                var content = "<h3>Car Park Number: " + coords.car_park_no + "</h3>" +
                    "<p>Address: " +  coords.address + "</p>" +
                    "<p>Type: " +  coords.car_park_type + "</p>" +
                    "<p>Free Parking: " +  coords.free_parking + "</p>" +
                    "<p>Night Parking: " +  coords.night_parking + "</p>" +
                    "<p>Parking System: " +  coords.type_of_parking_system + "</p>";

                var infowindow = new google.maps.InfoWindow();
                google.maps.event.addListener(marker, 'click', (function(marker, content, infowindow) {
                    return function() {
                        if(infowindow.isOpen) {
                            infowindow.close();
                            infowindow.isOpen = false;
                        } else {
                            if (prev_infowindow != false) {
                                prev_infowindow.close();
                                prev_infowindow.isOpen = false;
                            }
                            infowindow.setContent(content);
                            infowindow.open(map,marker);
                            infowindow.isOpen = true;
                        }
                        prev_infowindow = infowindow;
                    };
                })(marker, content, infowindow));
                google.maps.event.addListener(infowindow, 'closeclick', (function(marker, content, infowindow) {
                    return function() {
                       infowindow.isOpen = false;
                    };
                })(marker, content, infowindow));
            }
            // Add a marker clusterer to manage the markers.
            var markerCluster = new MarkerClusterer(map, markersArray,
                {imagePath: '../images/m'}
            );
        }

        function selectIndiv() {
            var msg = getJsonFromUrl().json;
            var jsonDecoded = unescape(msg);
            jsonDecoded = jsonDecoded.replace(/\+/g, ' ');
            var Json = JSON.parse(jsonDecoded);

            var cv = new SVY21();
            var coords = Json;
            var result = cv.computeLatLon(coords.y_coord, coords.x_coord);
            var latLng = new google.maps.LatLng(result.lat, result.lon);

            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 16,
                center: latLng,
                mapTypeId: google.maps.MapTypeId.TERRAIN
            });

            var marker = new google.maps.Marker({
                map: map,
                title: coords.car_park_no,
                position: latLng
            });
            var content = "<h3>Car Park Number: " + coords.car_park_no + "</h3>" +
                "<p>Address: " + coords.address + "</p>" +
                "<p>Type: " + coords.car_park_type + "</p>" +
                "<p>Free Parking: " + coords.free_parking + "</p>" +
                "<p>Night Parking: " + coords.night_parking + "</p>" +
                "<p>Parking System: " + coords.type_of_parking_system + "</p>";

            var infowindow = new google.maps.InfoWindow();
            google.maps.event.addListener(marker,'click', (function(marker, content, infowindow) {
                return function() {
                    if(infowindow.isOpen) {
                        infowindow.close();
                        infowindow.isOpen = false;
                    } else {
                        if (prev_infowindow != false) {
                            prev_infowindow.close();
                            prev_infowindow.isOpen = false;
                        }
                        infowindow.setContent(content);
                        infowindow.open(map,marker);
                        infowindow.isOpen = true;
                    }
                    prev_infowindow = infowindow;
                };
            })(marker, content, infowindow));
            google.maps.event.addListener(infowindow,'closeclick', (function(marker, content, infowindow) {
                return function() {
                   infowindow.isOpen = false;
                };
            })(marker, content, infowindow));
        }

        function selectMulti(jsonArr) {
            var json = JSON.parse(jsonArr);

            var theUrl = "https://data.gov.sg/api/action/datastore_search?resource_id=139a3035-e624-4f56-b63f-89ae28d4ae4c&limit=2000&offset=";
            var offset = 0;
            var cv = new SVY21();
            var carparkRecords = [];

            do {
                var xmlHttp = new XMLHttpRequest();
                xmlHttp.open( "GET", theUrl + offset, false ); // false for synchronous request
                xmlHttp.send( null );
                //console.log(xmlHttp.responseText);
                var jsonObject = JSON.parse(xmlHttp.responseText);
                for (var i = 0; i < jsonObject.result.records.length; i++) {
                    carparkRecords.push(jsonObject.result.records[i]);
                }
                offset += 2000;
            } while (jsonObject.result.records.length == 2000)

            let filteredCarparkRecords = carparkRecords.filter(function({address, car_park_no, car_park_type,
            free_parking, night_parking, short_term_parking, type_of_parking_system,
            x_coord, y_coord}) {
                return !this.has(address) && !this.has(car_park_no) &&
                !this.has(car_park_type) && !this.has(free_parking) &&
                !this.has(night_parking) && !this.has(short_term_parking) &&
                !this.has(type_of_parking_system) && !this.has(x_coord) &&
                !this.has(y_coord) && this.add(car_park_no);
            }, new Set);
            let iterator = filteredCarparkRecords.values();

            var dict = {};
            var data = [];

            for (var i = 0; i < filteredCarparkRecords.length; i++) {
                var record = iterator.next().value;
                dict[record.car_park_no] = record;
            }

            for (var j = 0; j < json.length; j++) {
				data.push(dict[json[j]]);
            }

            var cv = new SVY21();
            var obj = JSON.parse(xmlHttp.responseText);
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 11,
                center: new google.maps.LatLng(1.3521, 103.8198),
                mapTypeId: google.maps.MapTypeId.TERRAIN
            });

            var latlngbounds = new google.maps.LatLngBounds();

            for (var i = 0; i < data.length; i++) {
                var record = data[i];
                var result = cv.computeLatLon(parseInt(record.y_coord), parseInt(record.x_coord));
                var latLng = new google.maps.LatLng(result.lat, result.lon);
                latlngbounds.extend(latLng);
                var marker = new google.maps.Marker({
                    map: map,
                    title: record.car_park_no,
                    position: latLng
                });
                markersArray.push(marker);
                var content = "<h3>Car Park Number: " + record.car_park_no + "</h3>" +
                    "<p>Address: " + record.address + "</p>" +
                    "<p>Type: " + record.car_park_type + "</p>" +
                    "<p>Free Parking: " + record.free_parking + "</p>" +
                    "<p>Night Parking: " + record.night_parking + "</p>" +
                    "<p>Parking System: " + record.type_of_parking_system + "</p>";

                var infowindow = new google.maps.InfoWindow();
                google.maps.event.addListener(marker, 'click', (function(marker, content, infowindow) {
                    return function() {
                        if(infowindow.isOpen) {
                            infowindow.close();
                            infowindow.isOpen = false;
                        } else {
                            if (prev_infowindow != false) {
                                prev_infowindow.close();
                                prev_infowindow.isOpen = false;
                            }
                            infowindow.setContent(content);
                            infowindow.open(map,marker);
                            infowindow.isOpen = true;
                        }
                        prev_infowindow = infowindow;
                    };
                })(marker, content, infowindow));
                google.maps.event.addListener(infowindow,'closeclick', (function(marker, content, infowindow) {
                    return function() {
                       infowindow.isOpen = false;
                    };
                })(marker, content, infowindow));
            }
            // Add a marker clusterer to manage the markers.
            var markerCluster = new MarkerClusterer(map, markersArray,
                {imagePath: '../images/m'}
            );
            map.fitBounds(latlngbounds);
        }

        function handleMaps() {
            var defaultFlag = getJsonFromUrl().isDefault;
            if (defaultFlag == 1) {
                initMap();
            } else {
                var isArrOrIndiv = getJsonFromUrl().jsonArr;
                if (isArrOrIndiv) {
                    selectMulti(getJsonFromUrl().jsonArr);
                } else {
                    selectIndiv();
                }
            }
        }
        </script>
            <script src="../script/svy21.js">
        </script>
            <script src="../script/markerclusterer.js">
        </script>
        <script async defer
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDhN4_NQ94uS9Z0Ix6AfRgeXZN1rVahjBE&callback=handleMaps">
    </script>
    </body>
</html>
